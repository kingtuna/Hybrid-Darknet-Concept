#include <stdbool.h>
#include <stdio.h>
#include <errno.h>
#include <string.h>
#include <unistd.h>
#include <netdb.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>
#include <netinet/in.h>
#include <err.h>

int handle_datagram(char buffer[], int count){
    if (strstr(buffer,"\x5c\x73\x74\x61\x74\x75\x73\x5c")!=NULL){
        //printf("Message received!\n");
        return 1;
    }
    else{
        return -1;
    }
}

int main(){
    //Create child(deamon) process
    pid_t process_id = fork();
    if (process_id<0){
        printf("Fork failure!\n");
        exit(1);
    }
    else if (process_id>0){
        //printf("Deamon process initialized!\n");
        //printf("Terminating parent process...\n");
        exit(0);
    }
    
    //IP address and port converted from string to struct sockaddr_in
    const char* hostname="0.0.0.0"; /* wildcard */
    const char* portname="7778";
   	struct addrinfo hints;
    
    //Content to reflect back
   	char content[]={0x43,0x7d,0xb9,0xdf,0x90,0x23,0xd6,0x1d,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x10,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0xa0,0x0d,0x00,0x04,0x44,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x04,0x38,0x01,0x01,0x00,0x14,0x03,0x00,0x00,0x24,0x01,0x01,0x00,0x00,0x80,0x01,0x00,0x05,0x80,0x02,0x00,0x02,0x80,0x04,0x00,0x02,0x80,0x03,0x00,0x01,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x03,0x00,0x00,0x24,0x02,0x01,0x00,0x00,0x80,0x01,0x00,0x05,0x80,0x02,0x00,0x01,0x80,0x04,0x00,0x02,0x80,0x03,0x00,0x01,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x03,0x00,0x00,0x24,0x03,0x01,0x00,0x00,0x80,0x01,0x00,0x01,0x80,0x02,0x00,0x02,0x80,0x04,0x00,0x01,0x80,0x03,0x00,0x01,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x03,0x00,0x00,0x24,0x04,0x01,0x00,0x00,0x80,0x01,0x00,0x01,0x80,0x02,0x00,0x01,0x80,0x04,0x00,0x01,0x80,0x03,0x00,0x01,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x03,0x00,0x00,0x24,0x05,0x01,0x00,0x00,0x80,0x01,0x00,0x05,0x80,0x02,0x00,0x02,0x80,0x04,0x00,0x02,0x80,0x03,0x00,0x03,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x03,0x00,0x00,0x24,0x06,0x01,0x00,0x00,0x80,0x01,0x00,0x05,0x80,0x02,0x00,0x01,0x80,0x04,0x00,0x02,0x80,0x03,0x00,0x03,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x03,0x00,0x00,0x24,0x07,0x01,0x00,0x00,0x80,0x01,0x00,0x01,0x80,0x02,0x00,0x02,0x80,0x04,0x00,0x01,0x80,0x03,0x00,0x03,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x03,0x00,0x00,0x24,0x08,0x01,0x00,0x00,0x80,0x01,0x00,0x01,0x80,0x02,0x00,0x01,0x80,0x04,0x00,0x01,0x80,0x03,0x00,0x03,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x03,0x00,0x00,0x24,0x09,0x01,0x00,0x00,0x80,0x01,0x00,0x05,0x80,0x02,0x00,0x02,0x80,0x04,0x00,0x02,0x80,0x03,0x00,0x01,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x03,0x00,0x00,0x24,0x0a,0x01,0x00,0x00,0x80,0x01,0x00,0x05,0x80,0x02,0x00,0x01,0x80,0x04,0x00,0x02,0x80,0x03,0x00,0x01,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x03,0x00,0x00,0x24,0x0b,0x01,0x00,0x00,0x80,0x01,0x00,0x01,0x80,0x02,0x00,0x02,0x80,0x04,0x00,0x01,0x80,0x03,0x00,0x01,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x03,0x00,0x00,0x24,0x0c,0x01,0x00,0x00,0x80,0x01,0x00,0x01,0x80,0x02,0x00,0x01,0x80,0x04,0x00,0x01,0x80,0x03,0x00,0x01,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x03,0x00,0x00,0x50,0x0d,0x01,0x00,0x00,0x80,0x01,0x00,0x05,0x80,0x02,0x00,0x02,0x80,0x04,0x00,0x02,0x80,0x03,0xfd,0xe9,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x7d,0x01,0x00,0x28,0x6e,0x00,0x6f,0x00,0x64,0x00,0x65,0x00,0x33,0x00,0x30,0x00,0x36,0x00,0x24,0x00,0x40,0x00,0x45,0x00,0x43,0x00,0x47,0x00,0x52,0x00,0x49,0x00,0x44,0x00,0x2e,0x00,0x4e,0x00,0x45,0x00,0x54,0x00,0x00,0x00,0x03,0x00,0x00,0x50,0x0e,0x01,0x00,0x00,0x80,0x01,0x00,0x05,0x80,0x02,0x00,0x02,0x80,0x04,0x00,0x02,0x80,0x03,0xfd,0xe9,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x40,0x00,0x00,0x28,0x6e,0x00,0x6f,0x00,0x64,0x00,0x65,0x00,0x33,0x00,0x30,0x00,0x36,0x00,0x24,0x00,0x40,0x00,0x45,0x00,0x43,0x00,0x47,0x00,0x52,0x00,0x49,0x00,0x44,0x00,0x2e,0x00,0x4e,0x00,0x45,0x00,0x54,0x00,0x00,0x00,0x03,0x00,0x00,0x50,0x0f,0x01,0x00,0x00,0x80,0x01,0x00,0x05,0x80,0x02,0x00,0x01,0x80,0x04,0x00,0x02,0x80,0x03,0xfd,0xe9,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x7d,0x01,0x00,0x28,0x6e,0x00,0x6f,0x00,0x64,0x00,0x65,0x00,0x33,0x00,0x30,0x00,0x36,0x00,0x24,0x00,0x40,0x00,0x45,0x00,0x43,0x00,0x47,0x00,0x52,0x00,0x49,0x00,0x44,0x00,0x2e,0x00,0x4e,0x00,0x45,0x00,0x54,0x00,0x00,0x00,0x03,0x00,0x00,0x50,0x10,0x01,0x00,0x00,0x80,0x01,0x00,0x05,0x80,0x02,0x00,0x01,0x80,0x04,0x00,0x02,0x80,0x03,0xfd,0xe9,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x40,0x00,0x00,0x28,0x6e,0x00,0x6f,0x00,0x64,0x00,0x65,0x00,0x33,0x00,0x30,0x00,0x36,0x00,0x24,0x00,0x40,0x00,0x45,0x00,0x43,0x00,0x47,0x00,0x52,0x00,0x49,0x00,0x44,0x00,0x2e,0x00,0x4e,0x00,0x45,0x00,0x54,0x00,0x00,0x00,0x03,0x00,0x00,0x50,0x11,0x01,0x00,0x00,0x80,0x01,0x00,0x01,0x80,0x02,0x00,0x02,0x80,0x04,0x00,0x01,0x80,0x03,0xfd,0xe9,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x7d,0x01,0x00,0x28,0x6e,0x00,0x6f,0x00,0x64,0x00,0x65,0x00,0x33,0x00,0x30,0x00,0x36,0x00,0x24,0x00,0x40,0x00,0x45,0x00,0x43,0x00,0x47,0x00,0x52,0x00,0x49,0x00,0x44,0x00,0x2e,0x00,0x4e,0x00,0x45,0x00,0x54,0x00,0x00,0x00,0x03,0x00,0x00,0x50,0x12,0x01,0x00,0x00,0x80,0x01,0x00,0x01,0x80,0x02,0x00,0x02,0x80,0x04,0x00,0x01,0x80,0x03,0xfd,0xe9,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x40,0x00,0x00,0x28,0x6e,0x00,0x6f,0x00,0x64,0x00,0x65,0x00,0x33,0x00,0x30,0x00,0x36,0x00,0x24,0x00,0x40,0x00,0x45,0x00,0x43,0x00,0x47,0x00,0x52,0x00,0x49,0x00,0x44,0x00,0x2e,0x00,0x4e,0x00,0x45,0x00,0x54,0x00,0x00,0x00,0x03,0x00,0x00,0x50,0x13,0x01,0x00,0x00,0x80,0x01,0x00,0x01,0x80,0x02,0x00,0x01,0x80,0x04,0x00,0x01,0x80,0x03,0xfd,0xe9,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x7d,0x01,0x00,0x28,0x6e,0x00,0x6f,0x00,0x64,0x00,0x65,0x00,0x33,0x00,0x30,0x00,0x36,0x00,0x24,0x00,0x40,0x00,0x45,0x00,0x43,0x00,0x47,0x00,0x52,0x00,0x49,0x00,0x44,0x00,0x2e,0x00,0x4e,0x00,0x45,0x00,0x54,0x00,0x00,0x00,0x00,0x00,0x00,0x50,0x14,0x01,0x00,0x00,0x80,0x01,0x00,0x01,0x80,0x02,0x00,0x01,0x80,0x04,0x00,0x01,0x80,0x03,0xfd,0xe9,0x80,0x0b,0x00,0x01,0x00,0x0c,0x00,0x04,0x00,0x00,0x70,0x80,0x40,0x00,0x00,0x28,0x6e,0x00,0x6f,0x00,0x64,0x00,0x65,0x00,0x33,0x00,0x30,0x00,0x36,0x00,0x24,0x00,0x40,0x00,0x45,0x00,0x43,0x00,0x47,0x00,0x52,0x00,0x49,0x00,0x44,0x00,0x2e,0x00,0x4e,0x00,0x45,0x00,0x54,0x00,0x00,0x00,0x0d,0x00,0x00,0x18,0x1e,0x2b,0x51,0x69,0x05,0x99,0x1c,0x7d,0x7c,0x96,0xfc,0xbf,0xb5,0x87,0xe4,0x61,0x00,0x00,0x00,0x02,0x0d,0x00,0x00,0x14,0x40,0x48,0xb7,0xd5,0x6e,0xbc,0xe8,0x85,0x25,0xe7,0xde,0x7f,0x00,0xd6,0xc2,0xd3,0x00,0x00,0x00,0x14,0x90,0xcb,0x80,0x91,0x3e,0xbb,0x69,0x6e,0x08,0x63,0x81,0xb5,0xec,0x42,0x7b,0x1f};
    while(1){
        memset(&hints,0,sizeof(hints));
        hints.ai_family=AF_INET;
        hints.ai_socktype=SOCK_DGRAM;
        hints.ai_protocol=0;
        hints.ai_flags=AI_PASSIVE|AI_ADDRCONFIG;
        
        struct addrinfo* res=0;
        int err = getaddrinfo(hostname,portname,&hints,&res);
        if (err!=0) {
            printf("ERROR");
        }
        //Create socket
        int fd=socket(res->ai_family,res->ai_socktype,res->ai_protocol);
        if (fd==-1) {
            printf("ERROR: socket");
        }
        //Bind socket
        if (bind(fd,res->ai_addr,res->ai_addrlen)==-1) {
            printf("ERROR: bind");
        }
        //Receive and handle datagrams
        char buffer[1549];
        struct sockaddr_in src_addr;
        socklen_t src_addr_len;
        ssize_t count;
        
        count = recvfrom(fd,buffer,sizeof(buffer),0,(struct sockaddr*)&src_addr,&src_addr_len);
        if (count==-1) {
            printf("ERROR: count=-1");
        }
        else if (count==sizeof(buffer)) {
            warn("datagram too large for buffer: truncated");
        }
        else {//Sending response
            if (handle_datagram(buffer,count)==1){
                sendto(fd,content,sizeof(content),0,(struct sockaddr*)&src_addr,src_addr_len);
            }
        }
        memset(&buffer[0],0,sizeof(buffer));
        close(fd);
    }
    return 0;
}

